{% load static %}
{% get_static_prefix as STATIC_URL %}
<html>
<head>
    <title>修改课程</title>

    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}/yui/cssreset/cssreset-min.css">
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}/yui/cssfonts/cssfonts-min.css">
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}/yui/cssbase/cssbase-min.css">
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}/yui/cssgrids/grids-min.css">
    <link rel="stylesheet" href="{{STATIC_URL}}/backoffice/css/base.css" type="text/css"/>
    <link rel="stylesheet" href="{{STATIC_URL}}/yui/cssbutton.css" type="text/css"/>
    <script src="{{STATIC_URL}}/yui/yui-min.js"></script>
    <style type="text/css">
        .yui3-skin-sam .yui3-button-color-blue {
            color: #fff;
            background-image: -webkit-gradient(linear, left top, left bottom, from(#599bdc), to(#3476b7));
            background-image: -webkit-linear-gradient(top, #599bdc, #3476b7);
            background-image: -moz-linear-gradient(top, #599bdc, #3476b7);
            background-image: -ms-linear-gradient(top, #599bdc, #3476b7);
            background-image: -o-linear-gradient(top, #599bdc, #3476b7);
            background-image: linear-gradient(top, #599bdc, #3476b7);
            filter: progid:DXImageTransform.Microsoft.gradient(startColorStr = '#599bdc', EndColorStr = '#3476b7');
            background-color: #3476b7;
        }

    </style>
</head>
<body>
<div class="yui3-g head">
    <div class="yui3-u-4-5">
    </div>
    <div class="yui3-u-1-5">
        <a href="/backoffice/logout" class="head_style">注销</a>
        <a href="/backoffice/index.html" class="head_style">返回首页</a>
    </div>
</div>
<div class="yui3-g yui3-skin-sam">
    <form action="/backoffice/course/{{course.id}}" method="post" id="editForm" enctype="multipart/form-data">
        {% csrf_token %}
        {% for field in form %}
        <div class="yui3-g" style="padding-top: 15px;">
            <div class="yui3-u-1-5" style="float:left;font-weight: bold;">{{field.label_tag}}:</div>
            <div class="yui3-u-4-5" style="float:left">
                <div class="yui3-g">
                    <div class="yui3-u-3-5" style="float:left;font-weight: bold;">
                        {{field}}
                    </div>
                    <div class="yui3-u-2-5 error_area">
                        {%for error in field.errors%}
                        {{error}}
                        {%endfor%}

                    </div>
                </div>
            </div>
            <div style="clear:both;"></div>
        </div>


        {%endfor%}

        <br/>

        <div class="yui3-g">
            <div class="yui3-u-1-2">
                <div class="yui3-g">
                    <div class="yui3-u-1-6">
                        候补学员
                    </div>
                    <div class="yui3-u-5-6">
                        <div class="yui3-g">
                            <div class="yui3-u-4-5">
                                <select name="waitingList" id="waitingList" multiple style="width: 250px;height:200px;">
                                    {% for enroll in waitingList%}
                                    <option value="{{enroll.id}}">{{enroll.email}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="yui3-u-1-5">
                                <button class="cancelEnrollButton"><<<</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="yui3-u-1-2">
                <div class="yui3-g">
                    <div class="yui3-u-5-6">
                        <div class="yui3-g">
                            <div class="yui3-u-1-5">
                                <button class="selectEnrollButton">>>></button>
                            </div>
                            <div class="yui3-u-4-5">
                                <select id="notWaitingList" multiple style="width: 250px;height:200px;">
                                    {% for enroll in notWaitingList%}
                                    <option value="{{enroll.id}}">{{enroll.email}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="yui3-u-1-6">
                        听课学员
                    </div>

                </div>
            </div>
        </div>
        <hr/>
        <input type="hidden" name="waitingList" id="waitingListHidden"/>
        <input type="hidden" name="notWaitingList" id="notWaitingListHidden"/>
        <input type="hidden" id="maxTrainee" value="{{course.maxTraineeAmount}}"/>

        <div id="submit_button" class="yui3-button"
             style="color: black;width:45px;letter-spacing: 5px;word-spacing:5px;margin-left: 0px;">修改
        </div>
        <div id="export_contacts" class="yui3-button"
             style="color: black;width:145px;letter-spacing: 5px;word-spacing:5px;margin-left: 0px;">导出听课会员列表
        </div>
    </form>
    <div id="startDate"></div>
    <div id="endDate"></div>
    <div id="courseStartDate"></div>
</div>
<form id="email_form" action="/backoffice/export" method="post">
    {% csrf_token %}
    <input type="hidden" id="recipient_list" name="recipient_list"/>
</form>
<script type="text/javascript" src="{{STATIC_URL}}jquery/jquery-1.7.1.min.js"></script>
<script src="{{STATIC_URL}}yui-base/yui-base-min.js"></script>
<script>
    $("#export_contacts").on("click",
            function () {
                var selectedOptionName = "";
                var selectItemArray = $("#notWaitingList option");
                for (var i = 0; i < selectItemArray.length; ++i) {
                    selectedOptionName += selectItemArray[i].text + ";";
                }
                selectedOptionName = selectedOptionName.substr(0, selectedOptionName.length - 1);
                if (selectedOptionName.length == 0) {
                    alert("听课学员不能为空！");
                    return;
                }
                $("#recipient_list").val(selectedOptionName);

                $("#email_form").submit();
            }
    )


    function changeElementComboList(from, to) {
        YUI().use('node', function (Y) {
                    var fromComboList = Y.one("#" + from),
                            traineeAmount = Y.one("#maxTrainee").get("value"),
                            toComboList = Y.one("#" + to);
                    fromComboList.get("options").each(
                            function () {

                                if (this.get("selected") == true) {
                                    if (from == 'waitingList' && toComboList.get("options").size() >= traineeAmount) {
                                        return;
                                    }
                                    toComboList.append(this)
                                }
                            }
                    )
                }
        )
    }

    function selectEnrollUser(e) {
        changeElementComboList('waitingList', 'notWaitingList');
        e.preventDefault();
    }

    function cancelEnrollUser(e) {
        changeElementComboList('notWaitingList', 'waitingList');
        e.preventDefault();

    }

    function submitForm(e) {
        e.preventDefault();
        YUI().use('node', function (Y) {
                    var waitingListHidden = Y.one("#waitingListHidden"),
                            notWaitingListHidden = Y.one("#notWaitingListHidden"),
                            waitingList = Y.one("#waitingList"),
                            notWaitingList = Y.one("#notWaitingList"),
                            notWaitingListValue = '',
                            waitngListValue = '';
                    waitingList.get("options").each(
                            function () {
                                waitngListValue += this.get('value') + '|';
                            }
                    )
                    waitngListValue = waitngListValue.substr(0, waitngListValue.length - 1);
                    notWaitingList.get("options").each(
                            function () {
                                notWaitingListValue += this.get('value') + '|';
                            }
                    )
                    notWaitingListValue = notWaitingListValue.substr(0, notWaitingListValue.length - 1);
                    Y.one("#waitingListHidden").set('value', waitngListValue);
                    Y.one("#notWaitingListHidden").set('value', notWaitingListValue);
                    Y.one("#editForm").submit()
                }
        )
    }


    YUI().use('calendar', 'datatype-date', 'node', 'event', function (Y) {
                var selectEnrollButton = Y.one(".selectEnrollButton"),
                        cancelEnrollButton = Y.one(".cancelEnrollButton"),
                        submitButton = Y.one("#submit_button");
                selectEnrollButton.on('click', selectEnrollUser);
                cancelEnrollButton.on('click', cancelEnrollUser);


                submitButton.on('click', submitForm);


                var start_time_input = Y.one("#id_enrollStartTime"),
                        end_time_input = Y.one("#id_enrollEndTime"),
                        start_course_input = Y.one("#id_courseStartTime");
                Y.one("#startDate").setXY(start_time_input.getXY())
                Y.one("#endDate").setXY(end_time_input.getXY())
                Y.one("#courseStartDate").setXY(start_course_input.getXY());
                var dtdate = Y.DataType.Date,
                        startCalendar = new Y.Calendar({
                            contentBox:"#startDate",
                            width:'340px',
                            showPrevMonth:true,
                            showNextMonth:true,
                            date:new Date(),
                            startDate:new Date()}).render(),
                        startCourseCalendar = new Y.Calendar({
                            contentBox:"#courseStartDate",
                            width:'340px',
                            showPrevMonth:true,
                            showNextMonth:true,
                            date:new Date(),
                            startDate:new Date()}).render(),
                        endCalendar = new Y.Calendar({
                            contentBox:"#endDate",
                            width:'340px',
                            showPrevMonth:false,
                            showNextMonth:false,
                            date:new Date(),
                            startDate:new Date()}).render();

                startCalendar.hide();
                endCalendar.hide();
                startCourseCalendar.hide();

                Y.one("#submit_button").on('click', function () {
                    Y.one("form").submit()
                })

                startCourseCalendar.on("selectionChange", function (ev) {
                    var newDate = ev.newSelection[0];
                    start_course_input.set('value', dtdate.format(newDate));
                    startCourseCalendar.hide()
                });


                startCalendar.on("selectionChange", function (ev) {
                    var newDate = ev.newSelection[0];
                    start_time_input.set('value', dtdate.format(newDate));
                    startCalendar.hide()
                });


                endCalendar.on("selectionChange", function (ev) {
                    var newDate = ev.newSelection[0];
                    end_time_input.set('value', dtdate.format(newDate));
                    endCalendar.hide()
                });

                start_time_input.setAttribute('readonly', 'readonly');
                end_time_input.setAttribute("readonly", "readonly");
                start_course_input.setAttribute('readonly', 'readonly');

                start_course_input.on('click', function (e) {
                            startCourseCalendar.show();
                        }
                );

                start_time_input.on('click', function (e) {
                            startCalendar.show();
                        }
                );

                end_time_input.on('click', function (e) {
                            endCalendar.show();
                        }
                );
            }
    )
</script>
</body>
</html>